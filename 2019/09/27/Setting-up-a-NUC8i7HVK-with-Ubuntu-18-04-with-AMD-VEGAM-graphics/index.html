<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="liunx,ubuntu,"><meta name="description" content="intel 冥王峡谷安装ubuntu 18 amd显卡的驱动方法"><meta name="keywords" content="liunx,ubuntu"><meta property="og:type" content="article"><meta property="og:title" content="Setting up a NUC8i7HVK with Ubuntu 18.04 with AMD VEGAM graphics"><meta property="og:url" content="https://syaofox.github.io/2019/09/27/Setting-up-a-NUC8i7HVK-with-Ubuntu-18-04-with-AMD-VEGAM-graphics/index.html"><meta property="og:site_name" content="Syaofox&#39;s Land"><meta property="og:description" content="intel 冥王峡谷安装ubuntu 18 amd显卡的驱动方法"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2019-09-28T03:57:58.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Setting up a NUC8i7HVK with Ubuntu 18.04 with AMD VEGAM graphics"><meta name="twitter:description" content="intel 冥王峡谷安装ubuntu 18 amd显卡的驱动方法"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://syaofox.github.io/2019/09/27/Setting-up-a-NUC8i7HVK-with-Ubuntu-18-04-with-AMD-VEGAM-graphics/"><title>Setting up a NUC8i7HVK with Ubuntu 18.04 with AMD VEGAM graphics | Syaofox's Land</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Syaofox's Land</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://syaofox.github.io/2019/09/27/Setting-up-a-NUC8i7HVK-with-Ubuntu-18-04-with-AMD-VEGAM-graphics/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Syaofox"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Syaofox's Land"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Setting up a NUC8i7HVK with Ubuntu 18.04 with AMD VEGAM graphics</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-27T08:54:14+08:00">2019-09-27</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a></span></span> <span class="post-meta-divider">|</span><span class="page-pv"><i class="fa fa-file-o"></i> 浏览<span class="busuanzi-value" id="busuanzi_value_page_pv"></span> 次</span></div></header><div class="post-body" itemprop="articleBody"><p><em>intel 冥王峡谷安装ubuntu 18 amd显卡的驱动方法</em></p><a id="more"></a><p>Setting up a NUC8i7HVK with Ubuntu 18.04 with AMD VEGAM graphics</p><p>I love my NUCs, and when I gave my mine to my daughters to watch movies and play games on, I had a perfect excuse to purchase a shiny new Hades Canyon NUC (NUC8i7HVK) with an AMD Vega M graphics card. Little did I know GNU/Linux wasn’t supported on it; I wrongly assumed that all NUCs were compatible with my preferred OS. I’m not gonna use Windows, so I was forced to put some time into setting up my NUC.</p><p>Thank goodness for the really smart people who actually figured out how to do it; I’m just documenting the steps I took trom their advice so that others can do the same (I’ve also linked to pretty much every page where I found good advice on this problem). The keystone advice came from user834610 on <a href="https://askubuntu.com/questions/1040440/graphics-drivers-for-intel-nuc-hades-canyon-nuc8i7hvk-amd-radeon-rx-vega-gh/1057051#1057051" target="_blank" rel="noopener">this</a> page and from a bunch of people <a href="https://www.reddit.com/r/intelnuc/comments/8ub4cc/running_linux_on_the_nuc8i7hnk_hades_canyon/" target="_blank" rel="noopener">here</a>.</p><p>Note: My Hades Canyon NUC is the one with the i78809G CPU (the more powerful of the two available options). From what I’ve read, at least one of the steps below may fail on the HC NUC with the other CPU. Fair warning!*</p><h3 id="Update-firmware"><a href="#Update-firmware" class="headerlink" title="Update firmware"></a>Update firmware</h3><ul><li>Download the BIOS file from <a href="https://downloadcenter.intel.com/download/28073/BIOS-Update-HNKBLi70-86A-" target="_blank" rel="noopener">here</a> (use the one for the F7 BIOS Update method)</li><li>Update the BIOS using <a href="https://www.intel.com/content/www/us/en/support/articles/000005850/mini-pcs.html" target="_blank" rel="noopener">these</a> instructions.</li></ul><h3 id="Install-Ubuntu-18-04-from-a-USB-stick"><a href="#Install-Ubuntu-18-04-from-a-USB-stick" class="headerlink" title="Install Ubuntu 18.04 from a USB stick"></a>Install Ubuntu 18.04 from a USB stick</h3><p>Make an Ubuntu startup media on a USB flash drive. I was about to link to the instructions for doing that, but if you don’t know how to do this already, it is probably not a good idea for you to continue down this road; it gets a little hairy if you’re a newbie to GNU/Linux! This NUC is not the place for your first Ubuntu rodeo.</p><ul><li>Plug in the USB startup media and fire up the NUC. It won’t work. It’ll show you the traditional choices (try Ubuntu, install Ubuntu), but no matter what you choose, you’ll get a black screen.<ul><li>That’s because the Linux grahics card drivers on the live media can’t deal with the hardware. You need to dumb everything down by telling the kernel “nomodeset,” meaning it’s not allowed to start video drivers until the system is running.</li></ul></li><li>After turning on the NUC, the moment you see the Grub screen (the try vs install options), press ‘e’. That’ll get you to a screen where you can configure the boot options.<ul><li>Replace the words ‘quiet splash’ with ‘nomodeset’. A bit like <a href="https://askubuntu.com/questions/1037865/hades-canyon-nuc8i7hvk-can-install-but-cant-boot" target="_blank" rel="noopener">this</a> but actually removing the ‘quiet splash’ (because instead of a pretty splash screen now you’ll see what’s actually going on - that’s the not ‘quiet’ part).</li><li>Press Control-X to exit and boot. Now it should work.</li></ul></li><li>Go through the usual process of installing Ubuntu.</li><li>When it finishes, it’ll fail to boot again, since the newly installed Ubuntu doesn’t have the nomodeset parameter and will try to activate the ungovernable video hardware.<ul><li>Do the whole nomodeset dance again. <a href="https://askubuntu.com/questions/38780/how-do-i-set-nomodeset-after-ive-already-installed-ubuntu/38782#38782" target="_blank" rel="noopener">Here</a> is a pretty good explanation of how to make the nomodeset option persistent (edit the /etc/default/grub file to add the nomodeset and then run sudo update-grub2).</li><li>I actually just booted, hit Control-Alt-F3 to get to a tty terminal instead of going to the GUI environment, edited the /etc/default/grub file (changed the line <code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash&quot;</code> to <code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;nomodeset&quot;</code>, then ran <code>sudo update-grub2</code> and rebooted. That worked and maybe saved a minute or two.</li></ul></li><li>You should end up with a working installation, but you’ll notice that you can’t change the display parameters, the HDMI sound output may not work, and if you try GLmark2, GLXGears -info, or glxinfo, you’ll see that there’s no hardware accleration. In other words, you’ve just put all of your hopes and dreams into the NUC’s graphics card in vain. You are where the person who asked <a href="https://askubuntu.com/questions/1040440/graphics-drivers-for-intel-nuc-hades-canyon-nuc8i7hvk-amd-radeon-rx-vega-gh/1057051#1057051" target="_blank" rel="noopener">this</a> question was!</li></ul><p>Now comes the tricky part. In order to get the graphics drivers working, we need to:</p><ul><li>Upgrade the Linux kernel to 4.18 or higher</li><li>Grab the vegam firmware blobs needed to talk to the hardware</li><li>Update Mesa to at least 18.1</li></ul><h3 id="Update-the-kernel"><a href="#Update-the-kernel" class="headerlink" title="Update the kernel"></a>Update the kernel</h3><p>Ubuntu comes with a frozen kernel. Version 18.04 Bionic Beaver comes with Linux kernel 4.15, and that’s what you get. The drivers for the AMD GPU come with Linux 4.17, and from what I understand serious support comes only with 4.18. In any case, you’ll have to upgrade.</p><p>You can do that manually like this:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.18-rc5/linux-headers-4.18.0-041800rc5_4.18.0-041800rc5.201807152130_all.deb</span><br><span class="line">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.18-rc5/linux-headers-4.18.0-041800rc5-generic_4.18.0-041800rc5.201807152130_amd64.deb</span><br><span class="line">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.18-rc5/linux-image-unsigned-4.18.0-041800rc5-generic_4.18.0-041800rc5.201807152130_amd64.deb</span><br><span class="line">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.18-rc5/linux-modules-4.18.0-041800rc5-generic_4.18.0-041800rc5.201807152130_amd64.deb</span><br><span class="line">sudo dpkg -i linux-*.deb</span><br></pre></td></tr></table></figure><p>But I cheated and just used UKUU.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:teejee2008/ppa</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install ukuu</span><br></pre></td></tr></table></figure><p>Ran UKUU from the GUI, chose the Linux Kernel 4.18.3, rebooted.</p><p>Of course, it failed to boot.</p><p>Because I had to go into the BIOS setup of the NUC and disable Secure Boot.</p><ul><li>On startup, press F2 to enter the settings, and set<ul><li><em>Advanced</em> -&gt; <em>Boot</em> -&gt; <em>Secure Boot</em> -&gt; <em>Secure Boot Config</em> -&gt; Secure Boot = <em>unchecked</em></li><li>like <a href="https://communities.intel.com/servlet/JiveServlet/download/543962-185888/SecureBoot.jpg" target="_blank" rel="noopener">this</a></li></ul></li></ul><p>After disabling Secure Boot, Ubuntu came up just fine, and running <code>uname -a</code> showed that I was now running the 4.18 kernel.</p><h3 id="Upgrade-Mesa"><a href="#Upgrade-Mesa" class="headerlink" title="Upgrade Mesa"></a>Upgrade Mesa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-x-swat/updates</span><br><span class="line">sudo apt dist-upgrade</span><br></pre></td></tr></table></figure><h3 id="Grab-the-AMD-Vega-M-Linux-driver-and-put-it-in-the-appropriate-directory"><a href="#Grab-the-AMD-Vega-M-Linux-driver-and-put-it-in-the-appropriate-directory" class="headerlink" title="Grab the AMD Vega M Linux driver and put it in the appropriate directory"></a>Grab the AMD Vega M Linux driver and put it in the appropriate directory</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -m -np https://people.freedesktop.org/~agd5f/radeon_ucode/vegam/</span><br><span class="line">sudo cp people.freedesktop.org/~agd5f/radeon_ucode/vegam/*.bin /lib/firmware/amdgpu</span><br></pre></td></tr></table></figure><p>Then update your Initial Ramdisk to recognize/choose the right kernel:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/update-initramfs -u -k all</span><br></pre></td></tr></table></figure><h3 id="Turn-off-the-nomodeset-option-again"><a href="#Turn-off-the-nomodeset-option-again" class="headerlink" title="Turn off the nomodeset option again"></a>Turn off the nomodeset option again</h3><ul><li>Change the relevant line in <code>/etc/default/grub</code> to <code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;&quot;</code></li><li>Run <code>sudo update-grub2</code> and reboot</li></ul></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>你的支持将鼓励我继续创造！</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="Syaofox 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.png" alt="Syaofox 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/liunx/" rel="tag"># liunx</a> <a href="/tags/ubuntu/" rel="tag"># ubuntu</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/09/26/Ubuntu18-04-修改DNS/" rel="next" title="Ubuntu18.04 修改DNS"><i class="fa fa-chevron-left"></i> Ubuntu18.04 修改DNS</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/09/27/ubuntu-18-4-HDMI声音有杂音的修复方法/" rel="prev" title="ubuntu 18.4 HDMI声音有杂音的修复方法">ubuntu 18.4 HDMI声音有杂音的修复方法<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Syaofox</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">7</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-firmware"><span class="nav-number">1.</span> <span class="nav-text">Update firmware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-Ubuntu-18-04-from-a-USB-stick"><span class="nav-number">2.</span> <span class="nav-text">Install Ubuntu 18.04 from a USB stick</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-the-kernel"><span class="nav-number">3.</span> <span class="nav-text">Update the kernel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Upgrade-Mesa"><span class="nav-number">4.</span> <span class="nav-text">Upgrade Mesa</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Grab-the-AMD-Vega-M-Linux-driver-and-put-it-in-the-appropriate-directory"><span class="nav-number">5.</span> <span class="nav-text">Grab the AMD Vega M Linux driver and put it in the appropriate directory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Turn-off-the-nomodeset-option-again"><span class="nav-number">6.</span> <span class="nav-text">Turn off the nomodeset option again</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">Syaofox</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user"></i> 访问<span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv"><i class="fa fa-eye"></i> 总访问<span class="busuanzi-value" id="busuanzi_value_site_pv"></span> 次</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body></html>